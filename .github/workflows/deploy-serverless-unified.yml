name: Deploy Serverless (Unified)

on:
  workflow_dispatch:
    inputs:
      component:
        description: "Composant Ã  dÃ©ployer"
        type: choice
        required: true
        default: "lambdas"
        options:
          - "lambdas"      # DynamoDB + Lambdas + API Gateway
          - "grafana"      # VPC + ECS + Grafana
          - "full"         # Tout (Lambdas + Grafana)
      action:
        description: "Action Terraform"
        type: choice
        required: true
        default: "plan"
        options:
          - "plan"
          - "apply"

env:
  AWS_REGION: eu-west-3
  TF_WORKING_DIR: ./infra/envs/serverless-dev

jobs:
  terraform:
    name: "Terraform ${{ github.event.inputs.action }} - ${{ github.event.inputs.component }}"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Create S3 Backend Bucket (if needed)
        run: |
          BUCKET="iot-playground-tfstate-serverless"
          REGION="${{ env.AWS_REGION }}"
          
          echo "ðŸª£ Checking if S3 bucket exists..."
          
          if ! aws s3api head-bucket --bucket "$BUCKET" --region "$REGION" 2>/dev/null; then
            echo "ðŸ“¦ Creating S3 bucket: $BUCKET"
            aws s3api create-bucket \
              --bucket "$BUCKET" \
              --region "$REGION" \
              --create-bucket-configuration LocationConstraint="$REGION"
            
            echo "ðŸ”’ Enabling versioning..."
            aws s3api put-bucket-versioning \
              --bucket "$BUCKET" \
              --versioning-configuration Status=Enabled \
              --region "$REGION"
            
            echo "ðŸ” Enabling encryption..."
            aws s3api put-bucket-encryption \
              --bucket "$BUCKET" \
              --server-side-encryption-configuration '{
                "Rules": [{
                  "ApplyServerSideEncryptionByDefault": {
                    "SSEAlgorithm": "AES256"
                  }
                }]
              }' \
              --region "$REGION"
            
            echo "âœ… S3 bucket created and configured"
          else
            echo "âœ… S3 bucket already exists"
          fi

      - name: Create DynamoDB Lock Table (if needed)
        run: |
          TABLE="terraform-lock"
          REGION="${{ env.AWS_REGION }}"
          
          echo "ðŸ” Checking if DynamoDB table exists..."
          
          if ! aws dynamodb describe-table --table-name "$TABLE" --region "$REGION" >/dev/null 2>&1; then
            echo "ðŸ“Š Creating DynamoDB table: $TABLE"
            aws dynamodb create-table \
              --table-name "$TABLE" \
              --attribute-definitions AttributeName=LockID,AttributeType=S \
              --key-schema AttributeName=LockID,KeyType=HASH \
              --billing-mode PAY_PER_REQUEST \
              --region "$REGION"
            
            echo "â³ Waiting for table to be active..."
            aws dynamodb wait table-exists --table-name "$TABLE" --region "$REGION"
            
            echo "âœ… DynamoDB table created"
          else
            echo "âœ… DynamoDB table already exists"
          fi

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      - name: Set Terraform Targets (Lambdas only)
        if: github.event.inputs.component == 'lambdas'
        run: |
          echo "TF_TARGET=-target=module.acm_lambda_api -target=module.dynamodb_tables -target=module.lambda_run_api -target=module.lambda_sensor_api -target=module.api_gateway_lambda_iot" >> $GITHUB_ENV

      - name: Set Terraform Targets (Grafana only)
        if: github.event.inputs.component == 'grafana'
        run: |
          echo "TF_TARGET=-target=module.acm_grafana -target=module.vpc_serverless -target=module.ecs_cluster_serverless -target=aws_iam_role.grafana_cloudwatch -target=aws_iam_role_policy.grafana_cloudwatch -target=module.grafana_serverless" >> $GITHUB_ENV

      - name: Set Terraform Targets (Full)
        if: github.event.inputs.component == 'full'
        run: |
          echo "TF_TARGET=" >> $GITHUB_ENV


      - name: Terraform Plan
        if: github.event.inputs.action == 'plan'
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          echo "ðŸ“‹ Running Terraform Plan for: ${{ github.event.inputs.component }}"
          terraform plan ${{ env.TF_TARGET }}

      - name: Terraform Apply
        if: github.event.inputs.action == 'apply'
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          echo "ðŸš€ Running Terraform Apply for: ${{ github.event.inputs.component }}"
          terraform apply -auto-approve ${{ env.TF_TARGET }}


      - name: Get Outputs
        if: github.event.inputs.action == 'apply'
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          echo "=========================================="
          echo "  ðŸ“‹ OUTPUTS"
          echo "=========================================="
          terraform output

      - name: Summary
        run: |
          echo "=========================================="
          echo "  âœ… ${{ github.event.inputs.action }} COMPLETED"
          echo "=========================================="
          echo ""
          echo "ðŸ“¦ Component: ${{ github.event.inputs.component }}"
          echo "ðŸŽ¯ Action: ${{ github.event.inputs.action }}"
          echo ""
          
          if [ "${{ github.event.inputs.component }}" == "lambdas" ]; then
            echo "ðŸ“‹ Resources affected:"
            echo "  â€¢ DynamoDB Tables (Runs, SensorData)"
            echo "  â€¢ Lambda Run API"
            echo "  â€¢ Lambda Sensor API"
            echo "  â€¢ API Gateway"
          elif [ "${{ github.event.inputs.component }}" == "grafana" ]; then
            echo "ðŸ“‹ Resources affected:"
            echo "  â€¢ VPC Serverless"
            echo "  â€¢ ECS Cluster"
            echo "  â€¢ Grafana ECS Service"
            echo "  â€¢ ALB Grafana"
            echo "  â€¢ IAM Role CloudWatch"
          else
            echo "ðŸ“‹ Resources affected:"
            echo "  â€¢ ALL (Lambdas + Grafana)"
          fi
          echo ""
          echo "=========================================="

