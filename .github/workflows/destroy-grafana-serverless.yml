name: Destroy Grafana Serverless (ECS)

on:
  workflow_dispatch:
    inputs:
      CONFIRM_DESTROY:
        description: "Tapez 'DESTROY' pour confirmer la destruction"
        required: true
      DESTROY_BACKEND:
        description: "D√©truire aussi le backend S3 + DynamoDB ?"
        type: choice
        required: true
        default: "no"
        options:
          - "no"
          - "yes"

env:
  AWS_REGION: eu-west-3
  TF_WORKING_DIR: ./infra/envs/grafana-serverless-dev

jobs:
  destroy-grafana:
    name: "Destroy Grafana Serverless Infrastructure"
    runs-on: ubuntu-latest
    if: github.event.inputs.CONFIRM_DESTROY == 'DESTROY'

    env:
      AWS_REGION: eu-west-3
      TF_WORKING_DIR: ./infra/envs/grafana-serverless-dev

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      - name: Terraform Destroy - Infrastructure
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          echo "üóëÔ∏è Destroying Grafana Serverless infrastructure..."
          terraform destroy -auto-approve
          echo "‚úÖ Infrastructure destroyed successfully"

      - name: Empty S3 Bucket (if destroying backend)
        if: github.event.inputs.DESTROY_BACKEND == 'yes'
        run: |
          set -e
          BUCKET="iot-playground-tfstate-grafana-serverless"
          REGION="${{ env.AWS_REGION }}"
          
          echo "üóëÔ∏è Emptying S3 bucket $BUCKET..."
          
          # Check if bucket exists
          if aws s3api head-bucket --bucket "$BUCKET" --region $REGION 2>/dev/null; then
            echo "üì¶ Bucket exists, proceeding with cleanup..."
            
            # Delete all objects (simple method)
            aws s3 rm s3://$BUCKET --recursive --region $REGION || true
            
            # Delete all versions (if versioning enabled)
            echo "üîÑ Deleting object versions..."
            aws s3api list-object-versions \
              --bucket $BUCKET \
              --region $REGION \
              --output json 2>/dev/null | \
            jq -r '.Versions[]? | "--key \"" + .Key + "\" --version-id \"" + .VersionId + "\""' | \
            while read -r args; do
              if [ -n "$args" ]; then
                eval aws s3api delete-object --bucket $BUCKET --region $REGION $args || true
              fi
            done
            
            # Delete all delete markers
            echo "üóëÔ∏è Deleting delete markers..."
            aws s3api list-object-versions \
              --bucket $BUCKET \
              --region $REGION \
              --output json 2>/dev/null | \
            jq -r '.DeleteMarkers[]? | "--key \"" + .Key + "\" --version-id \"" + .VersionId + "\""' | \
            while read -r args; do
              if [ -n "$args" ]; then
                eval aws s3api delete-object --bucket $BUCKET --region $REGION $args || true
              fi
            done
            
            echo "‚úÖ S3 bucket emptied"
          else
            echo "‚ö†Ô∏è Bucket $BUCKET does not exist, skipping"
          fi

      - name: Delete S3 Bucket (if destroying backend)
        if: github.event.inputs.DESTROY_BACKEND == 'yes'
        run: |
          set -e
          BUCKET="iot-playground-tfstate-grafana-serverless"
          REGION="${{ env.AWS_REGION }}"
          
          echo "üóëÔ∏è Deleting S3 bucket $BUCKET..."
          
          if aws s3api head-bucket --bucket "$BUCKET" 2>/dev/null; then
            aws s3api delete-bucket --bucket $BUCKET --region $REGION
            echo "‚úÖ S3 bucket deleted"
          else
            echo "‚ö†Ô∏è Bucket $BUCKET does not exist, skipping"
          fi

      - name: Delete DynamoDB Table (if destroying backend)
        if: github.event.inputs.DESTROY_BACKEND == 'yes'
        run: |
          set -e
          TABLE="terraform-lock-grafana-serverless"
          REGION="${{ env.AWS_REGION }}"
          
          echo "üóëÔ∏è Deleting DynamoDB table $TABLE..."
          
          if aws dynamodb describe-table --table-name $TABLE --region $REGION >/dev/null 2>&1; then
            aws dynamodb delete-table --table-name $TABLE --region $REGION
            echo "‚úÖ DynamoDB table deleted"
          else
            echo "‚ö†Ô∏è Table $TABLE does not exist, skipping"
          fi

      - name: Summary
        run: |
          echo "=========================================="
          echo "  ‚úÖ DESTRUCTION COMPLETED"
          echo "=========================================="
          echo ""
          echo "üìã Resources destroyed:"
          echo "  ‚úÖ Grafana ECS Service + Task"
          echo "  ‚úÖ ALB + Target Group"
          echo "  ‚úÖ ECS Cluster"
          echo "  ‚úÖ VPC + Subnets + NAT Gateways"
          echo "  ‚úÖ IAM Role CloudWatch"
          echo "  ‚úÖ Security Groups"
          echo ""
          if [ "${{ github.event.inputs.DESTROY_BACKEND }}" == "yes" ]; then
            echo "  ‚úÖ S3 Backend Bucket (iot-playground-tfstate-grafana-serverless)"
            echo "  ‚úÖ DynamoDB Lock Table (terraform-lock-grafana-serverless)"
            echo ""
            echo "‚ö†Ô∏è  Backend d√©truit : vous devrez le recr√©er pour red√©ployer"
          else
            echo "  ‚ÑπÔ∏è  S3 Backend conserv√© (peut √™tre r√©utilis√©)"
            echo "  ‚ÑπÔ∏è  DynamoDB Lock conserv√©"
          fi
          echo ""
          echo "=========================================="

  abort-if-no-confirmation:
    name: "‚ùå Confirmation Required"
    runs-on: ubuntu-latest
    if: github.event.inputs.CONFIRM_DESTROY != 'DESTROY'

    steps:
      - name: Abort
        run: |
          echo "‚ùå DESTRUCTION ANNUL√âE"
          echo ""
          echo "Pour d√©truire l'infrastructure, vous devez taper 'DESTROY' dans le champ de confirmation."
          echo ""
          exit 1

