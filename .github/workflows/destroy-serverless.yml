name: Destroy Serverless Infrastructure

on:
  workflow_dispatch:
    inputs:
      component:
        description: "Composant √† d√©truire"
        type: choice
        required: true
        default: "lambdas"
        options:
          - "lambdas"      # DynamoDB + Lambdas + API Gateway + ACM
          - "grafana"      # VPC + ECS + Grafana
          - "full"         # Tout (Lambdas + Grafana)
      CONFIRM_DESTROY:
        description: "Tapez 'DESTROY' pour confirmer"
        required: true
      DESTROY_BACKEND:
        description: "D√©truire aussi le backend S3 + DynamoDB ?"
        type: choice
        required: true
        default: "no"
        options:
          - "no"
          - "yes"

env:
  AWS_REGION: eu-west-3
  TF_WORKING_DIR: ./infra/envs/serverless-dev

jobs:
  destroy:
    name: "Destroy Serverless - ${{ github.event.inputs.component }}"
    runs-on: ubuntu-latest
    if: github.event.inputs.CONFIRM_DESTROY == 'DESTROY'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Remove local Terraform state files
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          echo "üßπ Cleaning local Terraform state..."
          rm -f terraform.tfstate terraform.tfstate.backup
          echo "‚úÖ Local state cleaned"

      - name: Clean DynamoDB checksums
        run: |
          TABLE="terraform-lock"
          REGION="${{ env.AWS_REGION }}"
          
          echo "üßπ Cleaning DynamoDB lock table checksums..."
          
          if aws dynamodb describe-table --table-name $TABLE --region $REGION 2>/dev/null; then
            aws dynamodb scan --table-name $TABLE --region $REGION --output json 2>/dev/null | \
            jq -r '.Items[]? | .LockID.S' | \
            while read -r lock_id; do
              if [ -n "$lock_id" ]; then
                aws dynamodb delete-item --table-name $TABLE --region $REGION --key "{\"LockID\":{\"S\":\"$lock_id\"}}" 2>/dev/null || true
              fi
            done
            echo "‚úÖ DynamoDB cleaned"
          fi

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      - name: Set Terraform Targets (Lambdas only)
        if: github.event.inputs.component == 'lambdas'
        run: |
          echo "TF_TARGET=-target=module.api_gateway_lambda_iot -target=module.lambda_sensor_api -target=module.lambda_run_api -target=module.dynamodb_tables -target=module.acm_lambda_api" >> $GITHUB_ENV

      - name: Set Terraform Targets (Grafana only)
        if: github.event.inputs.component == 'grafana'
        run: |
          echo "TF_TARGET=-target=module.grafana_serverless -target=aws_iam_role_policy.grafana_cloudwatch -target=aws_iam_role.grafana_cloudwatch -target=module.ecs_cluster_serverless -target=module.vpc_serverless" >> $GITHUB_ENV

      - name: Set Terraform Targets (Full)
        if: github.event.inputs.component == 'full'
        run: |
          echo "TF_TARGET=" >> $GITHUB_ENV

      - name: Terraform Destroy
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          echo "üóëÔ∏è Running Terraform Destroy for: ${{ github.event.inputs.component }}"
          terraform destroy -auto-approve ${{ env.TF_TARGET }}

      - name: Cleanup Backend (S3 + DynamoDB)
        if: github.event.inputs.DESTROY_BACKEND == 'yes'
        run: |
          BUCKET="iot-playground-tfstate-serverless"
          TABLE="terraform-lock"
          REGION="${{ env.AWS_REGION }}"
          
          echo "üóëÔ∏è Cleaning up Terraform backend..."
          
          # Empty and delete S3 bucket
          if aws s3api head-bucket --bucket "$BUCKET" --region "$REGION" 2>/dev/null; then
            echo "üì¶ Emptying S3 bucket..."
            aws s3 rm s3://$BUCKET --recursive --region $REGION || true
            
            # Delete versions
            aws s3api list-object-versions --bucket $BUCKET --region $REGION --output json 2>/dev/null | \
            jq -r '.Versions[]? | "--key \"" + .Key + "\" --version-id \"" + .VersionId + "\""' | \
            while read -r args; do
              if [ -n "$args" ]; then
                eval aws s3api delete-object --bucket $BUCKET --region $REGION $args || true
              fi
            done
            
            # Delete delete markers
            aws s3api list-object-versions --bucket $BUCKET --region $REGION --output json 2>/dev/null | \
            jq -r '.DeleteMarkers[]? | "--key \"" + .Key + "\" --version-id \"" + .VersionId + "\""' | \
            while read -r args; do
              if [ -n "$args" ]; then
                eval aws s3api delete-object --bucket $BUCKET --region $REGION $args || true
              fi
            done
            
            echo "üóëÔ∏è Deleting S3 bucket..."
            aws s3api delete-bucket --bucket $BUCKET --region $REGION || true
            echo "‚úÖ S3 bucket deleted"
          fi
          
          # Delete DynamoDB table
          if aws dynamodb describe-table --table-name $TABLE --region $REGION 2>/dev/null; then
            echo "üóëÔ∏è Emptying DynamoDB table..."
            # Scan and delete all items first
            aws dynamodb scan --table-name $TABLE --region $REGION --output json 2>/dev/null | \
            jq -r '.Items[]? | .LockID.S' | \
            while read -r lock_id; do
              if [ -n "$lock_id" ]; then
                aws dynamodb delete-item --table-name $TABLE --region $REGION --key "{\"LockID\":{\"S\":\"$lock_id\"}}" || true
              fi
            done
            
            echo "üóëÔ∏è Deleting DynamoDB table..."
            aws dynamodb delete-table --table-name $TABLE --region $REGION || true
            echo "‚úÖ DynamoDB table deleted"
          fi
          
          echo "‚úÖ Backend cleanup complete"

      - name: Summary
        if: always()
        run: |
          echo "=========================================="
          echo "  üóëÔ∏è DESTROY COMPLETED"
          echo "=========================================="
          echo ""
          echo "üì¶ Component: ${{ github.event.inputs.component }}"
          echo "üßπ Backend cleanup: ${{ github.event.inputs.DESTROY_BACKEND }}"
          echo ""
          
          if [ "${{ github.event.inputs.component }}" == "lambdas" ]; then
            echo "üìã Resources destroyed:"
            echo "  ‚Ä¢ ACM Certificate"
            echo "  ‚Ä¢ API Gateway + Domain"
            echo "  ‚Ä¢ Lambda Run API"
            echo "  ‚Ä¢ Lambda Sensor API"
            echo "  ‚Ä¢ DynamoDB Tables (Runs, SensorData)"
          elif [ "${{ github.event.inputs.component }}" == "grafana" ]; then
            echo "üìã Resources destroyed:"
            echo "  ‚Ä¢ Grafana ECS Service"
            echo "  ‚Ä¢ ECS Cluster"
            echo "  ‚Ä¢ VPC Serverless (subnets, IGW, NAT)"
            echo "  ‚Ä¢ ALB Grafana"
            echo "  ‚Ä¢ IAM Role CloudWatch"
          else
            echo "üìã Resources destroyed:"
            echo "  ‚Ä¢ ALL (Lambdas + Grafana)"
          fi
          
          if [ "${{ github.event.inputs.DESTROY_BACKEND }}" == "yes" ]; then
            echo ""
            echo "üßπ Backend destroyed:"
            echo "  ‚Ä¢ S3 bucket: iot-playground-tfstate-serverless"
            echo "  ‚Ä¢ DynamoDB table: terraform-lock"
          fi
          
          echo ""
          echo "=========================================="

