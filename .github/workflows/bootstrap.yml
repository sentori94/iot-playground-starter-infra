name: "Terraform Bootstrap"

on:
  repository_dispatch:
    types: [trigger-bootstrap]

# EmpÃªcher les exÃ©cutions concurrentes
concurrency:
  group: bootstrap-infrastructure
  cancel-in-progress: false

env:
  AWS_REGION: eu-west-3

jobs:
  setup-backend:
    name: "Setup Backend (S3+DynamoDB)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ env.AWS_REGION }}
      - name: Create S3 bucket + DynamoDB if missing
        run: |
          set -e
          BUCKET="${{ github.event.client_payload.STATE_BUCKET_NAME }}"
          REGION="${{ env.AWS_REGION }}"

          # S3 bucket (idempotent)
          if aws s3api head-bucket --bucket "$BUCKET" 2>/dev/null; then
            echo "Bucket $BUCKET already exists"
          else
            if [ "$REGION" = "us-east-1" ]; then
              aws s3api create-bucket --bucket "$BUCKET"
            else
              aws s3api create-bucket --bucket "$BUCKET" \
                --create-bucket-configuration LocationConstraint="$REGION"
            fi
          fi

          # DynamoDB table (idempotent) - note: PAY_PER_REQUEST (et pas PAYPERREQUEST)
          if aws dynamodb describe-table --table-name terraform-locks >/dev/null 2>&1; then
            echo "DynamoDB table terraform-locks already exists"
          else
            aws dynamodb create-table \
              --table-name terraform-locks \
              --billing-mode PAY_PER_REQUEST \
              --attribute-definitions AttributeName=LockID,AttributeType=S \
              --key-schema AttributeName=LockID,KeyType=HASH
          fi

  deploy-infra:
    name: "Deploy Infra [${{ github.event.client_payload.MODE }}]"
    needs: setup-backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform init (configure S3 backend)
        working-directory: infra/envs/dev
        run: |
          terraform init -input=false \
            -backend-config="bucket=${{ github.event.client_payload.STATE_BUCKET_NAME }}" \
            -backend-config="key=envs/dev/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=terraform-locks" \
            -backend-config="encrypt=true"

      - name: Terraform plan
        if: ${{ github.event.client_payload.MODE == 'plan' }}
        working-directory: infra/envs/dev
        run: terraform plan -no-color -input=false -var="state_bucket_name=${{ github.event.client_payload.STATE_BUCKET_NAME }}" -var="xray_access_key_id=${{ secrets.XRAY_AWS_ACCESS_KEY_ID }}" -var="xray_secret_access_key=${{ secrets.XRAY_AWS_SECRET_ACCESS_KEY }}"

      - name: Terraform apply
        if: ${{ github.event.client_payload.MODE == 'apply' }}
        working-directory: infra/envs/dev
        run: terraform apply -auto-approve -input=false -var="state_bucket_name=${{ github.event.client_payload.STATE_BUCKET_NAME }}" -var="xray_access_key_id=${{ secrets.XRAY_AWS_ACCESS_KEY_ID }}" -var="xray_secret_access_key=${{ secrets.XRAY_AWS_SECRET_ACCESS_KEY }}"

      - name: Output Infrastructure Information
        if: github.event.client_payload.MODE == 'apply'
        working-directory: infra/envs/dev
        run: |
          echo "### ðŸš€ Infrastructure Bootstrap Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** dev" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "**State Bucket:** ${{ github.event.client_payload.STATE_BUCKET_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸŒ Network Resources:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **VPC ID:** \`$(terraform output -raw vpc_id 2>/dev/null || echo "N/A")\`" >> $GITHUB_STEP_SUMMARY
          echo "- **VPC CIDR:** \`$(terraform output -raw vpc_cidr 2>/dev/null || echo "N/A")\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ–¥ï¸ Compute Resources:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ECS Cluster:** \`$(terraform output -raw ecs_cluster_name 2>/dev/null || echo "N/A")\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Spring App Service:** \`$(terraform output -raw spring_app_service_name 2>/dev/null || echo "N/A")\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ”— Load Balancers:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          SPRING_ALB_DNS=$(terraform output -raw spring_app_alb_dns_name 2>/dev/null || echo "N/A")
          echo "- **Spring App ALB:** \`${SPRING_ALB_DNS}\`" >> $GITHUB_STEP_SUMMARY
          PROMETHEUS_ALB_DNS=$(terraform output -raw prometheus_alb_dns_name 2>/dev/null || echo "N/A")
          echo "- **Prometheus ALB:** \`${PROMETHEUS_ALB_DNS}\`" >> $GITHUB_STEP_SUMMARY
          GRAFANA_ALB_DNS=$(terraform output -raw grafana_alb_dns_name 2>/dev/null || echo "N/A")
          echo "- **Grafana ALB:** \`${GRAFANA_ALB_DNS}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ—„ï¸ Database:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **RDS Endpoint:** \`$(terraform output -raw rds_endpoint 2>/dev/null || echo "N/A")\`" >> $GITHUB_STEP_SUMMARY
          echo "- **RDS Database Name:** \`$(terraform output -raw rds_database_name 2>/dev/null || echo "N/A")\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“¡ API Endpoints:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          REPORTS_API=$(terraform output -raw reports_api_url 2>/dev/null || echo "N/A")
          echo "- **Reports Download API:** \`${REPORTS_API}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸŒ DNS (Route53):" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Spring App URL:** \`$(terraform output -raw spring_app_url 2>/dev/null || echo "N/A")\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Prometheus URL:** \`$(terraform output -raw prometheus_url 2>/dev/null || echo "N/A")\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Grafana URL:** \`$(terraform output -raw grafana_url 2>/dev/null || echo "N/A")\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“Š Monitoring:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          GRAFANA_URL=$(terraform output -raw grafana_url 2>/dev/null || echo "N/A")
          PROMETHEUS_URL=$(terraform output -raw prometheus_url 2>/dev/null || echo "N/A")
          echo "- [Open Grafana Dashboard](http://${GRAFANA_URL})" >> $GITHUB_STEP_SUMMARY
          echo "- [Open Prometheus](http://${PROMETHEUS_URL})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### âœ… Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Deploy your Spring Boot application to ECS" >> $GITHUB_STEP_SUMMARY
          echo "2. Configure your frontend with the API endpoints" >> $GITHUB_STEP_SUMMARY
          echo "3. Access Grafana to monitor your infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "4. Check CloudWatch logs for application insights" >> $GITHUB_STEP_SUMMARY
