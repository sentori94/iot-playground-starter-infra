name: "Deploy CDN Infrastructure"

on:
  workflow_dispatch:
    inputs:
      MODE:
        description: "Terraform mode"
        type: choice
        required: true
        default: plan
        options: [plan, apply]
      STATE_BUCKET_NAME:
        description: "Nom du bucket S3 pour le state Terraform CDN"
        required: true
        default: iot-playground-tfstate-cdn
      ENVIRONMENT:
        description: "Environment"
        type: choice
        required: true
        default: dev
        options: [dev, prod, staging]

env:
  AWS_REGION: us-east-1
  TF_VAR_aws_region: us-east-1

jobs:
  setup-cdn-backend:
    name: "Setup CDN Backend (S3+DynamoDB)"
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Create S3 bucket + DynamoDB if missing
        run: |
          set -e
          BUCKET="${{ github.event.inputs.STATE_BUCKET_NAME }}"
          REGION="${{ env.AWS_REGION }}"

          # S3 bucket (idempotent)
          if aws s3api head-bucket --bucket "$BUCKET" 2>/dev/null; then
            echo "Bucket $BUCKET already exists"
          else
            if [ "$REGION" = "us-east-1" ]; then
              aws s3api create-bucket --bucket "$BUCKET"
            else
              aws s3api create-bucket --bucket "$BUCKET" \
                --create-bucket-configuration LocationConstraint="$REGION"
            fi
            echo "Created bucket $BUCKET"
          fi

          # Enable versioning
          aws s3api put-bucket-versioning \
            --bucket "$BUCKET" \
            --versioning-configuration Status=Enabled

          # DynamoDB table (idempotent)
          if aws dynamodb describe-table --table-name terraform-locks-cdn >/dev/null 2>&1; then
            echo "DynamoDB table terraform-locks-cdn already exists"
          else
            aws dynamodb create-table \
              --table-name terraform-locks-cdn \
              --billing-mode PAY_PER_REQUEST \
              --attribute-definitions AttributeName=LockID,AttributeType=S \
              --key-schema AttributeName=LockID,KeyType=HASH
            echo "Created DynamoDB table terraform-locks-cdn"
          fi

  deploy-cdn:
    name: "Deploy CDN [${{ github.event.inputs.MODE }}]"
    needs: setup-cdn-backend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: infra/envs/cdn-${{ github.event.inputs.ENVIRONMENT }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ github.event.inputs.STATE_BUCKET_NAME }}" \
            -backend-config="key=${{ github.event.inputs.ENVIRONMENT }}/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=terraform-locks-cdn"

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        run: terraform plan -var="env=${{ github.event.inputs.ENVIRONMENT }}" -out=tfplan

      - name: Terraform Apply
        if: github.event.inputs.MODE == 'apply'
        run: terraform apply -auto-approve tfplan

      - name: Output CDN Information
        if: github.event.inputs.MODE == 'apply'
        run: |
          echo "### ðŸš€ CDN Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**S3 Bucket Name:**" >> $GITHUB_STEP_SUMMARY
          terraform output -raw s3_bucket_name >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**CloudFront Distribution ID:**" >> $GITHUB_STEP_SUMMARY
          terraform output -raw cloudfront_distribution_id >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**CloudFront URL:**" >> $GITHUB_STEP_SUMMARY
          terraform output -raw cloudfront_url >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Save Outputs as Artifacts
        if: github.event.inputs.MODE == 'apply'
        run: |
          mkdir -p outputs
          terraform output -json > outputs/cdn-outputs.json
          terraform output s3_bucket_name > outputs/s3_bucket_name.txt
          terraform output cloudfront_distribution_id > outputs/cloudfront_distribution_id.txt

      - name: Upload Outputs
        if: github.event.inputs.MODE == 'apply'
        uses: actions/upload-artifact@v4
        with:
          name: cdn-outputs-${{ github.event.inputs.ENVIRONMENT }}
          path: infra/envs/cdn-${{ github.event.inputs.ENVIRONMENT }}/outputs/
          retention-days: 30
